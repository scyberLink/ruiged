/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable require-jsdoc */
import SharedConfig from './SharedConfig';
import md5, { rand } from './md5';
import { API_VERSION, BASE } from '../configs/RestEndpoints';
import axios from 'axios';
var FetcherResponseType;
(function (FetcherResponseType) {
    FetcherResponseType[FetcherResponseType["JSON"] = 0] = "JSON";
    FetcherResponseType[FetcherResponseType["RESPONSE"] = 1] = "RESPONSE";
    FetcherResponseType[FetcherResponseType["BLOB"] = 2] = "BLOB";
})(FetcherResponseType || (FetcherResponseType = {}));
class Fetcher {
    static instance;
    base_url;
    listeners;
    frequency;
    FAIL_SAFE_THRESHOLD;
    constructor() {
        this.base_url = `${BASE}/${API_VERSION}`;
        this.listeners = {};
        this.frequency = 30000;
        this.FAIL_SAFE_THRESHOLD = 500;
    }
    addListenerForUrl(fetchOptions, listener, frequency = this.frequency, returnType = FetcherResponseType.JSON, failstop = this.FAIL_SAFE_THRESHOLD) {
        if (!fetchOptions)
            throw new Error('Invalid fetch options provided');
        if (!listener)
            throw new Error('Invalid listener provided');
        if (!returnType)
            throw new Error('Invalid returnType provided');
        if (!frequency)
            throw new Error('Invalid frequency provided');
        if (!failstop)
            throw new Error('Invalid failstop provided');
        const id = this.getId();
        const intervalId = setInterval(async () => {
            const intervalOwner = this.listeners[id];
            const hasReachThreshHold = intervalOwner.fail - intervalOwner.success >= failstop;
            try {
                const data = await this.fetch(fetchOptions, returnType);
                if (data) {
                    ++intervalOwner.success;
                    listener(data);
                }
                else {
                    if (hasReachThreshHold) {
                        this.removeListener(id);
                    }
                    else {
                        ++intervalOwner.fail;
                    }
                }
            }
            catch (e) {
                if (hasReachThreshHold) {
                    this.removeListener(id);
                }
                else {
                    ++intervalOwner.fail;
                }
            }
        }, frequency);
        this.listeners[id] = {
            fetchOptions: fetchOptions,
            listener: listener,
            intervalId: intervalId,
            fail: 0,
            success: 0,
        };
        return id;
    }
    removeListener(id) {
        if (!id)
            throw Error('Id required to remove listener');
        if (Object.hasOwnProperty.call(this.listeners, id)) {
            this.clear(this.listeners[id].intervalId);
            delete this.listeners[id];
        }
    }
    async release() {
        return new Promise((resolve) => {
            let listenersArr = Object.values(this.listeners);
            listenersArr.forEach((listener) => {
                this.clear(listener.intervalId);
            });
            this.listeners = {};
            listenersArr = [];
            resolve(true);
        });
    }
    async fetch(options, returnType = FetcherResponseType.JSON) {
        let url;
        const defaultOptions = {
            method: 'POST',
        };
        if (typeof options === 'string') {
            url = options;
            defaultOptions.method = 'GET';
            options = defaultOptions;
        }
        else {
            url = options.url;
            if (url) {
                delete options.url;
            }
            else {
                throw new Error('URL not found in options');
            }
            options = { ...defaultOptions, ...options };
        }
        options.headers = {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            'Cache-Control': ' no-cache',
            ...options.headers,
        };
        const auth = SharedConfig?.getLocalData('auth');
        auth && (options.headers['Authorization'] = auth);
        if (url.search('http') < 1) {
            url = `${this.base_url}${url}`;
        }
        options = { url, ...options };
        returnType == FetcherResponseType.BLOB && (options = { ...options, responseType: 'blob' });
        let res;
        try {
            res = await axios(options);
        }
        catch (err) {
            if (!err?.response?.data) {
                throw new Error(err.message);
            }
            res = err.response;
        }
        const data = res?.data;
        if (data?.connection?.statusCode == 401) {
            SharedConfig.removeLocalData('auth');
        }
        return returnType == FetcherResponseType.RESPONSE ? res : data;
    }
    clear(intervalId) {
        clearInterval(intervalId);
    }
    getId() {
        let id = md5(`${rand()}`);
        while (Object.hasOwnProperty.call(this.listeners, id)) {
            id = md5(rand());
        }
        return id;
    }
}
export { FetcherResponseType };
export default Fetcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmV0Y2hlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vRmV0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx1REFBdUQ7QUFDdkQsa0NBQWtDO0FBQ2xDLE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFBO0FBQ3pDLE9BQU8sR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sT0FBTyxDQUFBO0FBQ2pDLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDNUQsT0FBTyxLQUF3QixNQUFNLE9BQU8sQ0FBQTtBQUk1QyxJQUFLLG1CQUlKO0FBSkQsV0FBSyxtQkFBbUI7SUFDdEIsNkRBQUksQ0FBQTtJQUNKLHFFQUFRLENBQUE7SUFDUiw2REFBSSxDQUFBO0FBQ04sQ0FBQyxFQUpJLG1CQUFtQixLQUFuQixtQkFBbUIsUUFJdkI7QUFFRCxNQUFNLE9BQU87SUFDWCxNQUFNLENBQUMsUUFBUSxDQUFTO0lBRXhCLFFBQVEsQ0FBUTtJQUNoQixTQUFTLENBQVk7SUFDckIsU0FBUyxDQUFRO0lBQ2pCLG1CQUFtQixDQUFRO0lBRTNCO1FBQ0UsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLElBQUksSUFBSSxXQUFXLEVBQUUsQ0FBQTtRQUN4QyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtRQUNuQixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQTtRQUN0QixJQUFJLENBQUMsbUJBQW1CLEdBQUcsR0FBRyxDQUFBO0lBQ2hDLENBQUM7SUFFRCxpQkFBaUIsQ0FDZixZQUF3QixFQUN4QixRQUFpQyxFQUNqQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFDMUIsVUFBVSxHQUFHLG1CQUFtQixDQUFDLElBQUksRUFDckMsUUFBUSxHQUFHLElBQUksQ0FBQyxtQkFBbUI7UUFFbkMsSUFBSSxDQUFDLFlBQVk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGdD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RUFBRSxtQkFBbUIsRUFBRSxDQUFBO0FBQzlCLGVBQWUsT0FBTyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuLyogZXNsaW50LWRpc2FibGUgcmVxdWlyZS1qc2RvYyAqL1xuaW1wb3J0IFNoYXJlZENvbmZpZyBmcm9tICcuL1NoYXJlZENvbmZpZydcbmltcG9ydCBtZDUsIHsgcmFuZCB9IGZyb20gJy4vbWQ1J1xuaW1wb3J0IHsgQVBJX1ZFUlNJT04sIEJBU0UgfSBmcm9tICcuLi9jb25maWdzL1Jlc3RFbmRwb2ludHMnXG5pbXBvcnQgYXhpb3MsIHsgQXhpb3NSZXNwb25zZSB9IGZyb20gJ2F4aW9zJ1xuaW1wb3J0IElBbnlPYmplY3QgZnJvbSAnLi9tb2RlbHMvSUFueU9iamVjdCdcbmltcG9ydCBJRmV0Y2hEYXRhIGZyb20gJy4vbW9kZWxzL0lGZXRjaERhdGEnXG5cbmVudW0gRmV0Y2hlclJlc3BvbnNlVHlwZSB7XG4gIEpTT04sXG4gIFJFU1BPTlNFLFxuICBCTE9CLFxufVxuXG5jbGFzcyBGZXRjaGVyIHtcbiAgc3RhdGljIGluc3RhbmNlOiBGZXRjaGVyXG5cbiAgYmFzZV91cmw6IHN0cmluZ1xuICBsaXN0ZW5lcnM6IElBbnlPYmplY3RcbiAgZnJlcXVlbmN5OiBudW1iZXJcbiAgRkFJTF9TQUZFX1RIUkVTSE9MRDogbnVtYmVyXG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5iYXNlX3VybCA9IGAke0JBU0V9LyR7QVBJX1ZFUlNJT059YFxuICAgIHRoaXMubGlzdGVuZXJzID0ge31cbiAgICB0aGlzLmZyZXF1ZW5jeSA9IDMwMDAwXG4gICAgdGhpcy5GQUlMX1NBRkVfVEhSRVNIT0xEID0gNTAwXG4gIH1cblxuICBhZGRMaXN0ZW5lckZvclVybChcbiAgICBmZXRjaE9wdGlvbnM6IElBbnlPYmplY3QsXG4gICAgbGlzdGVuZXI6IChhcmcwOiB1bmtub3duKSA9PiB2b2lkLFxuICAgIGZyZXF1ZW5jeSA9IHRoaXMuZnJlcXVlbmN5LFxuICAgIHJldHVyblR5cGUgPSBGZXRjaGVyUmVzcG9uc2VUeXBlLkpTT04sXG4gICAgZmFpbHN0b3AgPSB0aGlzLkZBSUxfU0FGRV9USFJFU0hPTEQsXG4gICkge1xuICAgIGlmICghZmV0Y2hPcHRpb25zKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZmV0Y2ggb3B0aW9ucyBwcm92aWRlZCcpXG4gICAgaWYgKCFsaXN0ZW5lcikgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGxpc3RlbmVyIHByb3ZpZGVkJylcbiAgICBpZiAoIXJldHVyblR5cGUpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByZXR1cm5UeXBlIHByb3ZpZGVkJylcbiAgICBpZiAoIWZyZXF1ZW5jeSkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGZyZXF1ZW5jeSBwcm92aWRlZCcpXG4gICAgaWYgKCFmYWlsc3RvcCkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGZhaWxzdG9wIHByb3ZpZGVkJylcbiAgICBjb25zdCBpZCA9IHRoaXMuZ2V0SWQoKVxuICAgIGNvbnN0IGludGVydmFsSWQgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnRlcnZhbE93bmVyID0gdGhpcy5saXN0ZW5lcnNbaWRdXG4gICAgICBjb25zdCBoYXNSZWFjaFRocmVzaEhvbGQgPSBpbnRlcnZhbE93bmVyLmZhaWwgLSBpbnRlcnZhbE93bmVyLnN1Y2Nlc3MgPj0gZmFpbHN0b3BcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmZldGNoKGZldGNoT3B0aW9ucywgcmV0dXJuVHlwZSlcbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICArK2ludGVydmFsT3duZXIuc3VjY2Vzc1xuICAgICAgICAgIGxpc3RlbmVyKGRhdGEpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGhhc1JlYWNoVGhyZXNoSG9sZCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcihpZClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgKytpbnRlcnZhbE93bmVyLmZhaWxcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGhhc1JlYWNoVGhyZXNoSG9sZCkge1xuICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoaWQpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgKytpbnRlcnZhbE93bmVyLmZhaWxcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sIGZyZXF1ZW5jeSlcbiAgICB0aGlzLmxpc3RlbmVyc1tpZF0gPSB7XG4gICAgICBmZXRjaE9wdGlvbnM6IGZldGNoT3B0aW9ucyxcbiAgICAgIGxpc3RlbmVyOiBsaXN0ZW5lcixcbiAgICAgIGludGVydmFsSWQ6IGludGVydmFsSWQsXG4gICAgICBmYWlsOiAwLFxuICAgICAgc3VjY2VzczogMCxcbiAgICB9XG4gICAgcmV0dXJuIGlkXG4gIH1cblxuICByZW1vdmVMaXN0ZW5lcihpZDogc3RyaW5nKSB7XG4gICAgaWYgKCFpZCkgdGhyb3cgRXJyb3IoJ0lkIHJlcXVpcmVkIHRvIHJlbW92ZSBsaXN0ZW5lcicpXG4gICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMubGlzdGVuZXJzLCBpZCkpIHtcbiAgICAgIHRoaXMuY2xlYXIodGhpcy5saXN0ZW5lcnNbaWRdLmludGVydmFsSWQpXG4gICAgICBkZWxldGUgdGhpcy5saXN0ZW5lcnNbaWRdXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVsZWFzZSgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCBsaXN0ZW5lcnNBcnIgPSBPYmplY3QudmFsdWVzKHRoaXMubGlzdGVuZXJzKVxuICAgICAgbGlzdGVuZXJzQXJyLmZvckVhY2goKGxpc3RlbmVyKSA9PiB7XG4gICAgICAgIHRoaXMuY2xlYXIobGlzdGVuZXIuaW50ZXJ2YWxJZClcbiAgICAgIH0pXG4gICAgICB0aGlzLmxpc3RlbmVycyA9IHt9XG4gICAgICBsaXN0ZW5lcnNBcnIgPSBbXVxuICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBmZXRjaChcbiAgICBvcHRpb25zOiBJQW55T2JqZWN0IHwgc3RyaW5nLFxuICAgIHJldHVyblR5cGUgPSBGZXRjaGVyUmVzcG9uc2VUeXBlLkpTT04sXG4gICk6IFByb21pc2U8SUZldGNoRGF0YSB8IEF4aW9zUmVzcG9uc2UgfCBCbG9iPiB7XG4gICAgbGV0IHVybFxuICAgIGNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHVybCA9IG9wdGlvbnNcbiAgICAgIGRlZmF1bHRPcHRpb25zLm1ldGhvZCA9ICdHRVQnXG4gICAgICBvcHRpb25zID0gZGVmYXVsdE9wdGlvbnNcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsID0gb3B0aW9ucy51cmxcbiAgICAgIGlmICh1cmwpIHtcbiAgICAgICAgZGVsZXRlIG9wdGlvbnMudXJsXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VSTCBub3QgZm91bmQgaW4gb3B0aW9ucycpXG4gICAgICB9XG4gICAgICBvcHRpb25zID0geyAuLi5kZWZhdWx0T3B0aW9ucywgLi4ub3B0aW9ucyB9XG4gICAgfVxuICAgIG9wdGlvbnMuaGVhZGVycyA9IHtcbiAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICdDYWNoZS1Db250cm9sJzogJyBuby1jYWNoZScsXG4gICAgICAuLi5vcHRpb25zLmhlYWRlcnMsXG4gICAgfVxuICAgIGNvbnN0IGF1dGggPSBTaGFyZWRDb25maWc/LmdldExvY2FsRGF0YSgnYXV0aCcpXG4gICAgYXV0aCAmJiAob3B0aW9ucy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBhdXRoKVxuICAgIGlmICh1cmwuc2VhcmNoKCdodHRwJykgPCAxKSB7XG4gICAgICB1cmwgPSBgJHt0aGlzLmJhc2VfdXJsfSR7dXJsfWBcbiAgICB9XG4gICAgb3B0aW9ucyA9IHsgdXJsLCAuLi5vcHRpb25zIH1cbiAgICByZXR1cm5UeXBlID09IEZldGNoZXJSZXNwb25zZVR5cGUuQkxPQiAmJiAob3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgcmVzcG9uc2VUeXBlOiAnYmxvYicgfSlcbiAgICBsZXQgcmVzXG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IGF3YWl0IGF4aW9zKG9wdGlvbnMpXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIGlmICghZXJyPy5yZXNwb25zZT8uZGF0YSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyLm1lc3NhZ2UpXG4gICAgICB9XG4gICAgICByZXMgPSBlcnIucmVzcG9uc2VcbiAgICB9XG4gICAgY29uc3QgZGF0YSA9IHJlcz8uZGF0YVxuICAgIGlmIChkYXRhPy5jb25uZWN0aW9uPy5zdGF0dXNDb2RlID09IDQwMSkge1xuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUxvY2FsRGF0YSgnYXV0aCcpXG4gICAgfVxuICAgIHJldHVybiByZXR1cm5UeXBlID09IEZldGNoZXJSZXNwb25zZVR5cGUuUkVTUE9OU0UgPyByZXMgOiBkYXRhXG4gIH1cblxuICBjbGVhcihpbnRlcnZhbElkOiBhbnkpIHtcbiAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpXG4gIH1cblxuICBnZXRJZCgpIHtcbiAgICBsZXQgaWQgPSBtZDUoYCR7cmFuZCgpfWApXG4gICAgd2hpbGUgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMubGlzdGVuZXJzLCBpZCkpIHtcbiAgICAgIGlkID0gbWQ1KHJhbmQoKSlcbiAgICB9XG4gICAgcmV0dXJuIGlkXG4gIH1cbn1cblxuZXhwb3J0IHsgRmV0Y2hlclJlc3BvbnNlVHlwZSB9XG5leHBvcnQgZGVmYXVsdCBGZXRjaGVyXG4iXX0=