"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExtensionState = void 0;
const SharedConfig_1 = __importDefault(require("../common/SharedConfig"));
const constants_1 = require("../common/constants");
const ExtensionLoader_1 = __importDefault(require("./ExtensionLoader"));
const builtinextensions_json_1 = __importDefault(require("../builtinextensions.json"));
const NullException_1 = __importDefault(require("../common/exceptions/NullException"));
var ExtensionState;
(function (ExtensionState) {
    ExtensionState["BUILTIN"] = "builtin";
    ExtensionState["ENABLE"] = "enable";
    ExtensionState["DISABLE"] = "disable";
    ExtensionState["INSTALL"] = "install";
    ExtensionState["MANUAL_INSTALL"] = "manualInstall";
})(ExtensionState = exports.ExtensionState || (exports.ExtensionState = {}));
class ExtensionPool {
    constructor(appContainer, load) {
        this.builtin = [];
        this.installed = {};
        this.enabled = {};
        this.disabled = {};
        this.manualInstalled = {};
        this.appContainer = appContainer;
        this.loader = new ExtensionLoader_1.default();
        this.init(load);
    }
    getEvent(id, eventType) {
        return new CustomEvent(eventType, {
            detail: { [constants_1.EXTENSION_EVENT_DATA]: id },
        });
    }
    dispatchEvent(id, eventType) {
        dispatchEvent(this.getEvent(id, eventType));
    }
    init(load) {
        return __awaiter(this, void 0, void 0, function* () {
            const installed = SharedConfig_1.default.getLocalData(constants_1.INSTALLED_EXTENSION);
            const enabled = SharedConfig_1.default.getLocalData(constants_1.ENABLED_EXTENSION);
            const disabled = SharedConfig_1.default.getLocalData(constants_1.DISABLED_EXTENSION);
            const manualInstalled = SharedConfig_1.default.getLocalData(constants_1.MANUAL_INSTALLED_EXTENSION);
            if (installed) {
                this.installed = installed;
            }
            if (enabled) {
                this.enabled = enabled;
            }
            if (disabled) {
                this.disabled = disabled;
            }
            if (manualInstalled) {
                this.manualInstalled = manualInstalled;
            }
            this.builtin = builtinextensions_json_1.default;
            if (!this.installed || Object.values(this.installed).length <= 0) {
                for (const id of this.builtin) {
                    this.install(id);
                }
            }
            this.loadExtension(load);
        });
    }
    loadExtension(load) {
        if (load && !this.appContainer) {
            throw new NullException_1.default('Cannot load extensions. App Container Object is null');
        }
        if (load) {
            for (const enabledExtension of Object.values(this.enabled)) {
                setTimeout(() => this.loader.load(enabledExtension, this.appContainer).catch((error) => {
                    console.error(error);
                }), 1000);
            }
        }
    }
    install(id) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.installed[id]) {
                return false;
            }
            this.remove(id);
            const extension = (yield this.loader.getExtension(id));
            if (!extension) {
                return false;
            }
            extension.builtin = this.builtin.some((extensionId) => id == extensionId);
            this.add(extension, ExtensionState.INSTALL, ExtensionState.ENABLE);
            this.dispatchEvent(id, constants_1.EVENT_EXTENSION_INSTALL);
            return true;
        });
    }
    manualInstall(extension) {
        this.remove(extension.id);
        this.add(extension, ExtensionState.MANUAL_INSTALL, ExtensionState.INSTALL, ExtensionState.ENABLE);
        this.dispatchEvent(extension.id, constants_1.EVENT_EXTENSION_MANUAL_INSTALL);
        return true;
    }
    uninstall(id) {
        const removed = this.remove(id);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_UNINSTALL);
        return removed;
    }
    remove(id, ...states) {
        if (!states || states.length < 1) {
            this.delete(id, ExtensionState.DISABLE);
            this.delete(id, ExtensionState.ENABLE);
            this.delete(id, ExtensionState.INSTALL);
            this.delete(id, ExtensionState.MANUAL_INSTALL);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.INSTALLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.ENABLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.DISABLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, id);
            return true;
        }
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    this.delete(id, ExtensionState.DISABLE);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.DISABLED_EXTENSION, id);
                    break;
                case ExtensionState.ENABLE:
                    this.delete(id, ExtensionState.ENABLE);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.ENABLED_EXTENSION, id);
                    break;
                case ExtensionState.INSTALL:
                    this.delete(id, ExtensionState.INSTALL);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.INSTALLED_EXTENSION, id);
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    this.delete(id, ExtensionState.MANUAL_INSTALL);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, id);
                    break;
            }
        }
    }
    delete(id, state) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        let deleted;
        switch (state) {
            case ExtensionState.DISABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.disabled[id];
                break;
            case ExtensionState.ENABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.enabled[id];
                break;
            case ExtensionState.INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.installed[id];
                break;
            case ExtensionState.MANUAL_INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.manualInstalled[id];
                break;
        }
        return deleted;
    }
    add(extension, ...states) {
        let activate = false;
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.DISABLED_EXTENSION, extension.id, extension);
                    this.disabled[extension.id] = extension;
                    break;
                case ExtensionState.ENABLE:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.ENABLED_EXTENSION, extension.id, extension);
                    this.enabled[extension.id] = extension;
                    !activate && (activate = true);
                    break;
                case ExtensionState.INSTALL:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    !activate && (activate = true);
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    !activate && (activate = true);
                    break;
            }
        }
        activate && this.loader.load(extension, this.appContainer);
    }
    enable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.DISABLE);
        this.add(extension, ExtensionState.ENABLE);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_ENABLE);
        return true;
    }
    disable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.ENABLE);
        this.add(extension, ExtensionState.DISABLE);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_DISABLE);
        return true;
    }
    isEnabled(id) {
        return !!this.enabled[id];
    }
    isDisabled(id) {
        return !!this.disabled[id];
    }
    isInstalled(id) {
        return !!this.installed[id];
    }
    isBuiltin(id) {
        var _a;
        return !!((_a = this.installed[id]) === null || _a === void 0 ? void 0 : _a.builtin);
    }
}
exports.default = ExtensionPool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXh0ZW5zaW9uUG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3J1aWcvc3JjL2V4dGVuc2lvbi9FeHRlbnNpb25Qb29sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDBFQUFpRDtBQUNqRCxtREFXNEI7QUFFNUIsd0VBQStDO0FBQy9DLHVGQUF5RDtBQUV6RCx1RkFBOEQ7QUFHOUQsSUFBWSxjQU1YO0FBTkQsV0FBWSxjQUFjO0lBQ3hCLHFDQUFtQixDQUFBO0lBQ25CLG1DQUFpQixDQUFBO0lBQ2pCLHFDQUFtQixDQUFBO0lBQ25CLHFDQUFtQixDQUFBO0lBQ25CLGtEQUFnQyxDQUFBO0FBQ2xDLENBQUMsRUFOVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQU16QjtBQVVELE1BQU0sYUFBYTtJQVVqQixZQUFZLFlBQTRCLEVBQUUsSUFBYztRQU5oRCxZQUFPLEdBQWEsRUFBRSxDQUFBO1FBQ3RCLGNBQVMsR0FBbUIsRUFBRSxDQUFBO1FBQzlCLFlBQU8sR0FBbUIsRUFBRSxDQUFBO1FBQzVCLGFBQVEsR0FBbUIsRUFBRSxDQUFBO1FBQzdCLG9CQUFlLEdBQW1CLEVBQUUsQ0FBQTtRQUcxQyxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQTtRQUNoQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUkseUJBQWUsRUFBRSxDQUFBO1FBRW5DLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDakIsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFVLEVBQUUsU0FBaUI7UUFDcEMsT0FBTyxJQUFJLFdBQVcsQ0FBNEIsU0FBUyxFQUFFO1lBQzNELE1BQU0sRUFBRSxFQUFFLENBQUMsZ0NBQW9CLENBQUMsRUFBRSxFQUFFLEVBQUU7U0FDdkMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELGFBQWEsQ0FBQyxFQUFVLEVBQUUsU0FBaUI7UUFDekMsYUFBYSxDQUFDLElBQUksQ0FBQyxR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LENBQUMsRUFBVTtRQUNuQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQzVCLENBQUM7SUFFRCxXQUFXLENBQUMsRUFBVTtRQUNwQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFRCxTQUFTLENBQUMsRUFBVTs7UUFDbEIsT0FBTyxDQUFDLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLDBDQUFFLE9BQU8sQ0FBQSxDQUFBO0lBQ3RDLENBQUM7Q0FDRjtBQUVELGtCQUFlLGFBQWEsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTaGFyZWRDb25maWcgZnJvbSAnLi4vY29tbW9uL1NoYXJlZENvbmZpZydcbmltcG9ydCB7XG4gIElOU1RBTExFRF9FWFRFTlNJT04sXG4gIEVOQUJMRURfRVhURU5TSU9OLFxuICBESVNBQkxFRF9FWFRFTlNJT04sXG4gIEVYVEVOU0lPTl9FVkVOVF9EQVRBLFxuICBFVkVOVF9FWFRFTlNJT05fRElTQUJMRSxcbiAgRVZFTlRfRVhURU5TSU9OX0VOQUJMRSxcbiAgRVZFTlRfRVhURU5TSU9OX0lOU1RBTEwsXG4gIEVWRU5UX0VYVEVOU0lPTl9NQU5VQUxfSU5TVEFMTCxcbiAgRVZFTlRfRVhURU5TSU9OX1VOSU5TVEFMTCxcbiAgTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04sXG59IGZyb20gJy4uL2NvbW1vbi9jb25zdGFudHMnXG5pbXBvcnQgSUFwcENvbnRhaW5lciBmcm9tICcuLi9sYXllcnMvdmlldy9hcHBsaWNhdGlvbi9jb21wb25lbnRzL2Jhc2UvbW9kZWwvSUFwcENvbnRhaW5lcidcbmltcG9ydCBFeHRlbnNpb25Mb2FkZXIgZnJvbSAnLi9FeHRlbnNpb25Mb2FkZXInXG5pbXBvcnQgYnVpbHRpbkV4dGVuc2lvbnMgZnJvbSAnLi4vYnVpbHRpbmV4dGVuc2lvbnMuanNvbidcbmltcG9ydCBJRXh0ZW5zaW9uIGZyb20gJy4vSUV4dGVuc2lvbidcbmltcG9ydCBOdWxsRXhjZXB0aW9uIGZyb20gJy4uL2NvbW1vbi9leGNlcHRpb25zL051bGxFeGNlcHRpb24nXG5pbXBvcnQgSUFueU9iamVjdCBmcm9tICcuLi9jb21tb24vbW9kZWxzL0lBbnlPYmplY3QnXG5cbmV4cG9ydCBlbnVtIEV4dGVuc2lvblN0YXRlIHtcbiAgQlVJTFRJTiA9ICdidWlsdGluJyxcbiAgRU5BQkxFID0gJ2VuYWJsZScsXG4gIERJU0FCTEUgPSAnZGlzYWJsZScsXG4gIElOU1RBTEwgPSAnaW5zdGFsbCcsXG4gIE1BTlVBTF9JTlNUQUxMID0gJ21hbnVhbEluc3RhbGwnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVYVEVOU0lPTl9FVkVOVF9EQVRBX1RZUEUge1xuICBbRVhURU5TSU9OX0VWRU5UX0RBVEFdOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25TdG9yZSB7XG4gIFtrZXk6IHN0cmluZ106IElFeHRlbnNpb25cbn1cblxuY2xhc3MgRXh0ZW5zaW9uUG9vbCB7XG4gIHByaXZhdGUgYXBwQ29udGFpbmVyPzogSUFwcENvbnRhaW5lclxuICBwcml2YXRlIGxvYWRlciE6IEV4dGVuc2lvbkxvYWRlclxuXG4gIHByaXZhdGUgYnVpbHRpbjogc3RyaW5nW10gPSBbXVxuICBwcml2YXRlIGluc3RhbGxlZDogRXh0ZW5zaW9uU3RvcmUgPSB7fVxuICBwcml2YXRlIGVuYWJsZWQ6IEV4dGVuc2lvblN0b3JlID0ge31cbiAgcHJpdmF0ZSBkaXNhYmxlZDogRXh0ZW5zaW9uU3RvcmUgPSB7fVxuICBwcml2YXRlIG1hbnVhbEluc3RhbGxlZDogRXh0ZW5zaW9uU3RvcmUgPSB7fVxuXG4gIGNvbnN0cnVjdG9yKGFwcENvbnRhaW5lcj86IElBcHBDb250YWluZXIsIGxvYWQ/OiBib29sZWFuKSB7XG4gICAgdGhpcy5hcHBDb250YWluZXIgPSBhcHBDb250YWluZXJcbiAgICB0aGlzLmxvYWRlciA9IG5ldyBFeHRlbnNpb25Mb2FkZXIoKVxuXG4gICAgdGhpcy5pbml0KGxvYWQpXG4gIH1cblxuICBnZXRFdmVudChpZDogc3RyaW5nLCBldmVudFR5cGU6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgQ3VzdG9tRXZlbnQ8RVhURU5TSU9OX0VWRU5UX0RBVEFfVFlQRT4oZXZlbnRUeXBlLCB7XG4gICAgICBkZXRhaWw6IHsgW0VYVEVOU0lPTl9FVkVOVF9EQVRBXTogaWQgfSxcbiAgICB9KVxuICB9XG5cbiAgZGlzcGF0Y2hFdmVudChpZDogc3RyaW5nLCBldmVudFR5cGU6IHN0cmluZykge1xuICAgIGRpc3BhdGNoRXZlbnQodGhpcy5nZXRFdmVudChpZCwgZXZlbnRUeXBlKSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaW5pdChsb2FkPzogYm9vbGVhbikge1xuICAgIGNvbnN0IGluc3RhbGxlZDogRXh0ZW5zaW9uU3RvcmUgPSBTaGFyZWRDb25maWcuZ2V0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04pIGFzIElBbnlPYmplY3RcbiAgICBjb25zdCBlbmFibGVkOiBFeHRlbnNpb25TdG9yZSA9IFNoYXJlZENvbmZpZy5nZXRMb2NhbERhdGEoRU5BQkxFRF9FWFRFTlNJT04pIGFzIElBbnlPYmplY3RcbiAgICBjb25zdCBkaXNhYmxlZDogRXh0ZW5zaW9uU3RvcmUgPSBTaGFyZWRDb25maWcuZ2V0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTikgYXMgSUFueU9iamVjdFxuICAgIGNvbnN0IG1hbnVhbEluc3RhbGxlZDogRXh0ZW5zaW9uU3RvcmUgPSBTaGFyZWRDb25maWcuZ2V0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OKSBhcyBJQW55T2JqZWN0XG5cbiAgICBpZiAoaW5zdGFsbGVkKSB7XG4gICAgICB0aGlzLmluc3RhbGxlZCA9IGluc3RhbGxlZFxuICAgIH1cblxuICAgIGlmIChlbmFibGVkKSB7XG4gICAgICB0aGlzLmVuYWJsZWQgPSBlbmFibGVkXG4gICAgfVxuXG4gICAgaWYgKGRpc2FibGVkKSB7XG4gICAgICB0aGlzLmRpc2FibGVkID0gZGlzYWJsZWRcbiAgICB9XG5cbiAgICBpZiAobWFudWFsSW5zdGFsbGVkKSB7XG4gICAgICB0aGlzLm1hbnVhbEluc3RhbGxlZCA9IG1hbnVhbEluc3RhbGxlZFxuICAgIH1cblxuICAgIHRoaXMuYnVpbHRpbiA9IGJ1aWx0aW5FeHRlbnNpb25zXG5cbiAgICBpZiAoIXRoaXMuaW5zdGFsbGVkIHx8IE9iamVjdC52YWx1ZXModGhpcy5pbnN0YWxsZWQpLmxlbmd0aCA8PSAwKSB7XG4gICAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMuYnVpbHRpbikge1xuICAgICAgICB0aGlzLmluc3RhbGwoaWQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5sb2FkRXh0ZW5zaW9uKGxvYWQpXG4gIH1cblxuICBsb2FkRXh0ZW5zaW9uKGxvYWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKGxvYWQgJiYgIXRoaXMuYXBwQ29udGFpbmVyKSB7XG4gICAgICB0aHJvdyBuZXcgTnVsbEV4Y2VwdGlvbignQ2Fubm90IGxvYWQgZXh0ZW5zaW9ucy4gQXBwIENvbnRhaW5lciBPYmplY3QgaXMgbnVsbCcpXG4gICAgfVxuICAgIGlmIChsb2FkKSB7XG4gICAgICBmb3IgKGNvbnN0IGVuYWJsZWRFeHRlbnNpb24gb2YgT2JqZWN0LnZhbHVlcyh0aGlzLmVuYWJsZWQpKSB7XG4gICAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICAgKCkgPT5cbiAgICAgICAgICAgIHRoaXMubG9hZGVyLmxvYWQoZW5hYmxlZEV4dGVuc2lvbiwgdGhpcy5hcHBDb250YWluZXIgYXMgSUFwcENvbnRhaW5lcikuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAxMDAwLFxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbChpZDogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuaW5zdGFsbGVkW2lkXSkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgdGhpcy5yZW1vdmUoaWQpXG5cbiAgICBjb25zdCBleHRlbnNpb246IElFeHRlbnNpb24gPSAoYXdhaXQgdGhpcy5sb2FkZXIuZ2V0RXh0ZW5zaW9uKGlkKSkgYXMgSUV4dGVuc2lvblxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICBleHRlbnNpb24uYnVpbHRpbiA9IHRoaXMuYnVpbHRpbi5zb21lKChleHRlbnNpb25JZCkgPT4gaWQgPT0gZXh0ZW5zaW9uSWQpXG5cbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLklOU1RBTEwsIEV4dGVuc2lvblN0YXRlLkVOQUJMRSlcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBtYW51YWxJbnN0YWxsKGV4dGVuc2lvbjogSUV4dGVuc2lvbikge1xuICAgIHRoaXMucmVtb3ZlKGV4dGVuc2lvbi5pZClcbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLk1BTlVBTF9JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV4dGVuc2lvbi5pZCwgRVZFTlRfRVhURU5TSU9OX01BTlVBTF9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICB1bmluc3RhbGwoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJlbW92ZWQgPSB0aGlzLnJlbW92ZShpZClcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9VTklOU1RBTEwpXG4gICAgcmV0dXJuIHJlbW92ZWRcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlKGlkOiBzdHJpbmcsIC4uLnN0YXRlczogRXh0ZW5zaW9uU3RhdGVbXSkge1xuICAgIGlmICghc3RhdGVzIHx8IHN0YXRlcy5sZW5ndGggPCAxKSB7XG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRSlcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTClcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTClcblxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoSU5TVEFMTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShESVNBQkxFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHN0YXRlcykge1xuICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkRJU0FCTEU6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRU5BQkxFKVxuICAgICAgICAgIHJldHVybiBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLklOU1RBTEw6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLklOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuTUFOVUFMX0lOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLCBpZClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlKGlkOiBzdHJpbmcsIHN0YXRlOiBFeHRlbnNpb25TdGF0ZSkge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgbGV0IGRlbGV0ZWRcblxuICAgIHN3aXRjaCAoc3RhdGUpIHtcbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmRpc2FibGVkW2lkXVxuICAgICAgICBicmVha1xuXG4gICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmVuYWJsZWRbaWRdXG4gICAgICAgIGJyZWFrXG5cbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcblxuICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLm1hbnVhbEluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVsZXRlZFxuICB9XG5cbiAgcHJpdmF0ZSBhZGQoZXh0ZW5zaW9uOiBJRXh0ZW5zaW9uLCAuLi5zdGF0ZXM6IEV4dGVuc2lvblN0YXRlW10pIHtcbiAgICBsZXQgYWN0aXZhdGUgPSBmYWxzZVxuICAgIGZvciAoY29uc3Qgc3RhdGUgb2Ygc3RhdGVzKSB7XG4gICAgICBzd2l0Y2ggKHN0YXRlKSB7XG4gICAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRTpcbiAgICAgICAgICBTaGFyZWRDb25maWcuYWRkVG9PYmplY3RMb2NhbERhdGEoRElTQUJMRURfRVhURU5TSU9OLCBleHRlbnNpb24uaWQsIGV4dGVuc2lvbilcbiAgICAgICAgICB0aGlzLmRpc2FibGVkW2V4dGVuc2lvbi5pZF0gPSBleHRlbnNpb25cbiAgICAgICAgICBicmVha1xuXG4gICAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuRU5BQkxFOlxuICAgICAgICAgIFNoYXJlZENvbmZpZy5hZGRUb09iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgZXh0ZW5zaW9uLmlkLCBleHRlbnNpb24pXG4gICAgICAgICAgdGhpcy5lbmFibGVkW2V4dGVuc2lvbi5pZF0gPSBleHRlbnNpb25cbiAgICAgICAgICAhYWN0aXZhdGUgJiYgKGFjdGl2YXRlID0gdHJ1ZSlcbiAgICAgICAgICBicmVha1xuXG4gICAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTDpcbiAgICAgICAgICBTaGFyZWRDb25maWcuYWRkVG9PYmplY3RMb2NhbERhdGEoSU5TVEFMTEVEX0VYVEVOU0lPTiwgZXh0ZW5zaW9uLmlkLCBleHRlbnNpb24pXG4gICAgICAgICAgdGhpcy5pbnN0YWxsZWRbZXh0ZW5zaW9uLmlkXSA9IGV4dGVuc2lvblxuICAgICAgICAgICFhY3RpdmF0ZSAmJiAoYWN0aXZhdGUgPSB0cnVlKVxuICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgICBTaGFyZWRDb25maWcuYWRkVG9PYmplY3RMb2NhbERhdGEoTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04sIGV4dGVuc2lvbi5pZCwgZXh0ZW5zaW9uKVxuICAgICAgICAgIHRoaXMuaW5zdGFsbGVkW2V4dGVuc2lvbi5pZF0gPSBleHRlbnNpb25cbiAgICAgICAgICAhYWN0aXZhdGUgJiYgKGFjdGl2YXRlID0gdHJ1ZSlcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgICBhY3RpdmF0ZSAmJiB0aGlzLmxvYWRlci5sb2FkKGV4dGVuc2lvbiwgdGhpcy5hcHBDb250YWluZXIgYXMgSUFwcENvbnRhaW5lcilcbiAgfVxuXG4gIGVuYWJsZShpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgZXh0ZW5zaW9uID0gdGhpcy5pbnN0YWxsZWRbaWRdXG4gICAgaWYgKCFleHRlbnNpb24pIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICB0aGlzLnJlbW92ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRSlcbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLkVOQUJMRSlcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9FTkFCTEUpXG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGRpc2FibGUoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgdGhpcy5yZW1vdmUoaWQsIEV4dGVuc2lvblN0YXRlLkVOQUJMRSlcbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGlkLCBFVkVOVF9FWFRFTlNJT05fRElTQUJMRSlcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgaXNFbmFibGVkKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISF0aGlzLmVuYWJsZWRbaWRdXG4gIH1cblxuICBpc0Rpc2FibGVkKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISF0aGlzLmRpc2FibGVkW2lkXVxuICB9XG5cbiAgaXNJbnN0YWxsZWQoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiAhIXRoaXMuaW5zdGFsbGVkW2lkXVxuICB9XG5cbiAgaXNCdWlsdGluKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISF0aGlzLmluc3RhbGxlZFtpZF0/LmJ1aWx0aW5cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFeHRlbnNpb25Qb29sXG4iXX0=