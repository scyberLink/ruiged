import SharedConfig from '../common/SharedConfig';
import { INSTALLED_EXTENSION, ENABLED_EXTENSION, DISABLED_EXTENSION, EXTENSION_EVENT_DATA, EVENT_EXTENSION_DISABLE, EVENT_EXTENSION_ENABLE, EVENT_EXTENSION_INSTALL, EVENT_EXTENSION_MANUAL_INSTALL, EVENT_EXTENSION_UNINSTALL, MANUAL_INSTALLED_EXTENSION, } from '../common/constants';
import ExtensionLoader from './ExtensionLoader';
import builtinExtensions from '../builtinextensions.json';
import NullException from '../common/exceptions/NullException';
export var ExtensionState;
(function (ExtensionState) {
    ExtensionState["BUILTIN"] = "builtin";
    ExtensionState["ENABLE"] = "enable";
    ExtensionState["DISABLE"] = "disable";
    ExtensionState["INSTALL"] = "install";
    ExtensionState["MANUAL_INSTALL"] = "manualInstall";
})(ExtensionState || (ExtensionState = {}));
class ExtensionPool {
    appContainer;
    loader;
    builtin = [];
    installed = {};
    enabled = {};
    disabled = {};
    manualInstalled = {};
    constructor(appContainer, load) {
        this.appContainer = appContainer;
        this.loader = new ExtensionLoader();
        this.init(load);
    }
    getEvent(id, eventType) {
        return new CustomEvent(eventType, {
            detail: { [EXTENSION_EVENT_DATA]: id },
        });
    }
    dispatchEvent(id, eventType) {
        dispatchEvent(this.getEvent(id, eventType));
    }
    async init(load) {
        const installed = SharedConfig.getLocalData(INSTALLED_EXTENSION);
        const enabled = SharedConfig.getLocalData(ENABLED_EXTENSION);
        const disabled = SharedConfig.getLocalData(DISABLED_EXTENSION);
        const manualInstalled = SharedConfig.getLocalData(MANUAL_INSTALLED_EXTENSION);
        if (installed) {
            this.installed = installed;
        }
        if (enabled) {
            this.enabled = enabled;
        }
        if (disabled) {
            this.disabled = disabled;
        }
        if (manualInstalled) {
            this.manualInstalled = manualInstalled;
        }
        this.builtin = builtinExtensions;
        if (!this.installed || Object.values(this.installed).length <= 0) {
            for (const id of this.builtin) {
                this.install(id);
            }
        }
        this.loadExtension(load);
    }
    loadExtension(load) {
        if (load && !this.appContainer) {
            throw new NullException('Cannot load extensions. App Container Object is null');
        }
        if (load) {
            for (const enabledExtension of Object.values(this.enabled)) {
                this.loader.load(enabledExtension.code, this.appContainer);
            }
        }
    }
    async install(id) {
        if (this.installed[id]) {
            return false;
        }
        this.remove(id);
        const extension = (await this.loader.getExtension(id));
        extension.builtin = this.builtin.some((extensionId) => id == extensionId);
        if (extension) {
            return false;
        }
        this.add(extension, ExtensionState.INSTALL, ExtensionState.ENABLE);
        this.dispatchEvent(id, EVENT_EXTENSION_INSTALL);
        return true;
    }
    manualInstall(extension) {
        this.remove(extension.id);
        this.add(extension, ExtensionState.MANUAL_INSTALL, ExtensionState.INSTALL, ExtensionState.ENABLE);
        this.dispatchEvent(extension.id, EVENT_EXTENSION_MANUAL_INSTALL);
        return true;
    }
    uninstall(id) {
        const removed = this.remove(id);
        this.dispatchEvent(id, EVENT_EXTENSION_UNINSTALL);
        return removed;
    }
    remove(id, ...states) {
        if (!states || states.length < 1) {
            this.delete(id, ExtensionState.DISABLE);
            this.delete(id, ExtensionState.ENABLE);
            this.delete(id, ExtensionState.INSTALL);
            this.delete(id, ExtensionState.MANUAL_INSTALL);
            SharedConfig.removeFromObjectLocalData(INSTALLED_EXTENSION, id);
            SharedConfig.removeFromObjectLocalData(ENABLED_EXTENSION, id);
            SharedConfig.removeFromObjectLocalData(DISABLED_EXTENSION, id);
            SharedConfig.removeFromObjectLocalData(MANUAL_INSTALLED_EXTENSION, id);
            return true;
        }
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    this.delete(id, ExtensionState.DISABLE);
                    return SharedConfig.removeFromObjectLocalData(DISABLED_EXTENSION, id);
                    break;
                case ExtensionState.ENABLE:
                    this.delete(id, ExtensionState.ENABLE);
                    return SharedConfig.removeFromObjectLocalData(ENABLED_EXTENSION, id);
                    break;
                case ExtensionState.INSTALL:
                    this.delete(id, ExtensionState.INSTALL);
                    return SharedConfig.removeFromObjectLocalData(INSTALLED_EXTENSION, id);
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    this.delete(id, ExtensionState.MANUAL_INSTALL);
                    return SharedConfig.removeFromObjectLocalData(MANUAL_INSTALLED_EXTENSION, id);
                    break;
            }
        }
    }
    delete(id, state) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        let deleted;
        switch (state) {
            case ExtensionState.DISABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.disabled[id];
                break;
            case ExtensionState.ENABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.enabled[id];
                break;
            case ExtensionState.INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.installed[id];
                break;
            case ExtensionState.MANUAL_INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.manualInstalled[id];
                break;
        }
        return deleted;
    }
    add(extension, ...states) {
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    SharedConfig.addToObjectLocalData(DISABLED_EXTENSION, extension.id, extension);
                    this.disabled[extension.id] = extension;
                    break;
                case ExtensionState.ENABLE:
                    SharedConfig.addToObjectLocalData(ENABLED_EXTENSION, extension.id, extension);
                    this.enabled[extension.id] = extension;
                    break;
                case ExtensionState.INSTALL:
                    SharedConfig.addToObjectLocalData(INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    SharedConfig.addToObjectLocalData(MANUAL_INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    break;
            }
        }
    }
    enable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.DISABLE);
        this.add(extension, ExtensionState.ENABLE);
        this.dispatchEvent(id, EVENT_EXTENSION_ENABLE);
        return true;
    }
    disable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.ENABLE);
        this.add(extension, ExtensionState.DISABLE);
        this.dispatchEvent(id, EVENT_EXTENSION_DISABLE);
        return true;
    }
    isEnabled(id) {
        return !!this.enabled[id];
    }
    isDisabled(id) {
        return !!this.disabled[id];
    }
    isInstalled(id) {
        return !!this.installed[id];
    }
    isBuiltin(id) {
        return !!this.installed[id]?.builtin;
    }
}
export default ExtensionPool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXh0ZW5zaW9uUG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHRlbnNpb24vRXh0ZW5zaW9uUG9vbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFlBQVksTUFBTSx3QkFBd0IsQ0FBQTtBQUNqRCxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUNqQixrQkFBa0IsRUFDbEIsb0JBQW9CLEVBQ3BCLHVCQUF1QixFQUN2QixzQkFBc0IsRUFDdEIsdUJBQXVCLEVBQ3ZCLDhCQUE4QixFQUM5Qix5QkFBeUIsRUFDekIsMEJBQTBCLEdBQzNCLE1BQU0scUJBQXFCLENBQUE7QUFFNUIsT0FBTyxlQUFlLE1BQU0sbUJBQW1CLENBQUE7QUFDL0MsT0FBTyxpQkFBaUIsTUFBTSwyQkFBMkIsQ0FBQTtBQUV6RCxPQUFPLGFBQWEsTUFBTSxvQ0FBb0MsQ0FBQTtBQUc5RCxNQUFNLENBQU4sSUFBWSxjQU1YO0FBTkQsV0FBWSxjQUFjO0lBQ3hCLHFDQUFtQixDQUFBO0lBQ25CLG1DQUFpQixDQUFBO0lBQ2pCLHFDQUFtQixDQUFBO0lBQ25CLHFDQUFtQixDQUFBO0lBQ25CLGtEQUFnQyxDQUFBO0FBQ2xDLENBQUMsRUFOVyxjQUFjLEtBQWQsY0FBYyxRQU16QjtBQVVELE1BQU0sYUFBYTtJQUNULFlBQVksQ0FBZ0I7SUFDNUIsTUFBTSxDQUFrQjtJQUV4QixPQUFPLEdBQWEsRUFBRSxDQUFBO0lBQ3RCLFNBQVMsR0FBbUIsRUFBRSxDQUFBO0lBQzlCLE9BQU8sR0FBbUIsRUFBRSxDQUFBO0lBQzVCLFFBQVEsR0FBbUIsRUFBRSxDQUFBO0lBQzdCLGVBQWUsR0FBbUIsRUFBRSxDQUFBO0lBRTVDLFlBQVksWUFBNEIsRUFBRSxJQUFjO1FBQ3RELElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFBO1FBQ2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQTtRQUVuQyxJQUFJLENBQUMs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UyxDQUFDLEVBQVU7UUFDbEIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBRSxPQUFPLENBQUE7SUFDdEMsQ0FBQztDQUNGO0FBRUQsZUFBZSxhQUFhLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2hhcmVkQ29uZmlnIGZyb20gJy4uL2NvbW1vbi9TaGFyZWRDb25maWcnXG5pbXBvcnQge1xuICBJTlNUQUxMRURfRVhURU5TSU9OLFxuICBFTkFCTEVEX0VYVEVOU0lPTixcbiAgRElTQUJMRURfRVhURU5TSU9OLFxuICBFWFRFTlNJT05fRVZFTlRfREFUQSxcbiAgRVZFTlRfRVhURU5TSU9OX0RJU0FCTEUsXG4gIEVWRU5UX0VYVEVOU0lPTl9FTkFCTEUsXG4gIEVWRU5UX0VYVEVOU0lPTl9JTlNUQUxMLFxuICBFVkVOVF9FWFRFTlNJT05fTUFOVUFMX0lOU1RBTEwsXG4gIEVWRU5UX0VYVEVOU0lPTl9VTklOU1RBTEwsXG4gIE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLFxufSBmcm9tICcuLi9jb21tb24vY29uc3RhbnRzJ1xuaW1wb3J0IElBcHBDb250YWluZXIgZnJvbSAnLi4vbGF5ZXJzL3ZpZXcvYXBwbGljYXRpb24vY29tcG9uZW50cy9iYXNlL21vZGVsL0lBcHBDb250YWluZXInXG5pbXBvcnQgRXh0ZW5zaW9uTG9hZGVyIGZyb20gJy4vRXh0ZW5zaW9uTG9hZGVyJ1xuaW1wb3J0IGJ1aWx0aW5FeHRlbnNpb25zIGZyb20gJy4uL2J1aWx0aW5leHRlbnNpb25zLmpzb24nXG5pbXBvcnQgSUV4dGVuc2lvbiBmcm9tICcuL0lFeHRlbnNpb24nXG5pbXBvcnQgTnVsbEV4Y2VwdGlvbiBmcm9tICcuLi9jb21tb24vZXhjZXB0aW9ucy9OdWxsRXhjZXB0aW9uJ1xuaW1wb3J0IElBbnlPYmplY3QgZnJvbSAnLi4vY29tbW9uL21vZGVscy9JQW55T2JqZWN0J1xuXG5leHBvcnQgZW51bSBFeHRlbnNpb25TdGF0ZSB7XG4gIEJVSUxUSU4gPSAnYnVpbHRpbicsXG4gIEVOQUJMRSA9ICdlbmFibGUnLFxuICBESVNBQkxFID0gJ2Rpc2FibGUnLFxuICBJTlNUQUxMID0gJ2luc3RhbGwnLFxuICBNQU5VQUxfSU5TVEFMTCA9ICdtYW51YWxJbnN0YWxsJyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFWFRFTlNJT05fRVZFTlRfREFUQV9UWVBFIHtcbiAgW0VYVEVOU0lPTl9FVkVOVF9EQVRBXTogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uU3RvcmUge1xuICBba2V5OiBzdHJpbmddOiBJRXh0ZW5zaW9uXG59XG5cbmNsYXNzIEV4dGVuc2lvblBvb2wge1xuICBwcml2YXRlIGFwcENvbnRhaW5lcj86IElBcHBDb250YWluZXJcbiAgcHJpdmF0ZSBsb2FkZXIhOiBFeHRlbnNpb25Mb2FkZXJcblxuICBwcml2YXRlIGJ1aWx0aW46IHN0cmluZ1tdID0gW11cbiAgcHJpdmF0ZSBpbnN0YWxsZWQ6IEV4dGVuc2lvblN0b3JlID0ge31cbiAgcHJpdmF0ZSBlbmFibGVkOiBFeHRlbnNpb25TdG9yZSA9IHt9XG4gIHByaXZhdGUgZGlzYWJsZWQ6IEV4dGVuc2lvblN0b3JlID0ge31cbiAgcHJpdmF0ZSBtYW51YWxJbnN0YWxsZWQ6IEV4dGVuc2lvblN0b3JlID0ge31cblxuICBjb25zdHJ1Y3RvcihhcHBDb250YWluZXI/OiBJQXBwQ29udGFpbmVyLCBsb2FkPzogYm9vbGVhbikge1xuICAgIHRoaXMuYXBwQ29udGFpbmVyID0gYXBwQ29udGFpbmVyXG4gICAgdGhpcy5sb2FkZXIgPSBuZXcgRXh0ZW5zaW9uTG9hZGVyKClcblxuICAgIHRoaXMuaW5pdChsb2FkKVxuICB9XG5cbiAgZ2V0RXZlbnQoaWQ6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IEN1c3RvbUV2ZW50PEVYVEVOU0lPTl9FVkVOVF9EQVRBX1RZUEU+KGV2ZW50VHlwZSwge1xuICAgICAgZGV0YWlsOiB7IFtFWFRFTlNJT05fRVZFTlRfREFUQV06IGlkIH0sXG4gICAgfSlcbiAgfVxuXG4gIGRpc3BhdGNoRXZlbnQoaWQ6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcpIHtcbiAgICBkaXNwYXRjaEV2ZW50KHRoaXMuZ2V0RXZlbnQoaWQsIGV2ZW50VHlwZSkpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXQobG9hZD86IGJvb2xlYW4pIHtcbiAgICBjb25zdCBpbnN0YWxsZWQ6IEV4dGVuc2lvblN0b3JlID0gU2hhcmVkQ29uZmlnLmdldExvY2FsRGF0YShJTlNUQUxMRURfRVhURU5TSU9OKSBhcyBJQW55T2JqZWN0XG4gICAgY29uc3QgZW5hYmxlZDogRXh0ZW5zaW9uU3RvcmUgPSBTaGFyZWRDb25maWcuZ2V0TG9jYWxEYXRhKEVOQUJMRURfRVhURU5TSU9OKSBhcyBJQW55T2JqZWN0XG4gICAgY29uc3QgZGlzYWJsZWQ6IEV4dGVuc2lvblN0b3JlID0gU2hhcmVkQ29uZmlnLmdldExvY2FsRGF0YShESVNBQkxFRF9FWFRFTlNJT04pIGFzIElBbnlPYmplY3RcbiAgICBjb25zdCBtYW51YWxJbnN0YWxsZWQ6IEV4dGVuc2lvblN0b3JlID0gU2hhcmVkQ29uZmlnLmdldExvY2FsRGF0YShNQU5VQUxfSU5TVEFMTEVEX0VYVEVOU0lPTikgYXMgSUFueU9iamVjdFxuXG4gICAgaWYgKGluc3RhbGxlZCkge1xuICAgICAgdGhpcy5pbnN0YWxsZWQgPSBpbnN0YWxsZWRcbiAgICB9XG5cbiAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgdGhpcy5lbmFibGVkID0gZW5hYmxlZFxuICAgIH1cblxuICAgIGlmIChkaXNhYmxlZCkge1xuICAgICAgdGhpcy5kaXNhYmxlZCA9IGRpc2FibGVkXG4gICAgfVxuXG4gICAgaWYgKG1hbnVhbEluc3RhbGxlZCkge1xuICAgICAgdGhpcy5tYW51YWxJbnN0YWxsZWQgPSBtYW51YWxJbnN0YWxsZWRcbiAgICB9XG5cbiAgICB0aGlzLmJ1aWx0aW4gPSBidWlsdGluRXh0ZW5zaW9uc1xuXG4gICAgaWYgKCF0aGlzLmluc3RhbGxlZCB8fCBPYmplY3QudmFsdWVzKHRoaXMuaW5zdGFsbGVkKS5sZW5ndGggPD0gMCkge1xuICAgICAgZm9yIChjb25zdCBpZCBvZiB0aGlzLmJ1aWx0aW4pIHtcbiAgICAgICAgdGhpcy5pbnN0YWxsKGlkKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMubG9hZEV4dGVuc2lvbihsb2FkKVxuICB9XG5cbiAgbG9hZEV4dGVuc2lvbihsb2FkPzogYm9vbGVhbikge1xuICAgIGlmIChsb2FkICYmICF0aGlzLmFwcENvbnRhaW5lcikge1xuICAgICAgdGhyb3cgbmV3IE51bGxFeGNlcHRpb24oJ0Nhbm5vdCBsb2FkIGV4dGVuc2lvbnMuIEFwcCBDb250YWluZXIgT2JqZWN0IGlzIG51bGwnKVxuICAgIH1cbiAgICBpZiAobG9hZCkge1xuICAgICAgZm9yIChjb25zdCBlbmFibGVkRXh0ZW5zaW9uIG9mIE9iamVjdC52YWx1ZXModGhpcy5lbmFibGVkKSkge1xuICAgICAgICB0aGlzLmxvYWRlci5sb2FkKGVuYWJsZWRFeHRlbnNpb24uY29kZSwgdGhpcy5hcHBDb250YWluZXIgYXMgSUFwcENvbnRhaW5lcilcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5pbnN0YWxsZWRbaWRdKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZShpZClcblxuICAgIGNvbnN0IGV4dGVuc2lvbjogSUV4dGVuc2lvbiA9IChhd2FpdCB0aGlzLmxvYWRlci5nZXRFeHRlbnNpb24oaWQpKSBhcyBJRXh0ZW5zaW9uXG4gICAgZXh0ZW5zaW9uIS5idWlsdGluID0gdGhpcy5idWlsdGluLnNvbWUoKGV4dGVuc2lvbklkKSA9PiBpZCA9PSBleHRlbnNpb25JZClcbiAgICBpZiAoZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLklOU1RBTEwsIEV4dGVuc2lvblN0YXRlLkVOQUJMRSlcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBtYW51YWxJbnN0YWxsKGV4dGVuc2lvbjogSUV4dGVuc2lvbikge1xuICAgIHRoaXMucmVtb3ZlKGV4dGVuc2lvbi5pZClcbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLk1BTlVBTF9JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV4dGVuc2lvbi5pZCwgRVZFTlRfRVhURU5TSU9OX01BTlVBTF9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICB1bmluc3RhbGwoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJlbW92ZWQgPSB0aGlzLnJlbW92ZShpZClcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9VTklOU1RBTEwpXG4gICAgcmV0dXJuIHJlbW92ZWRcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlKGlkOiBzdHJpbmcsIC4uLnN0YXRlczogRXh0ZW5zaW9uU3RhdGVbXSkge1xuICAgIGlmICghc3RhdGVzIHx8IHN0YXRlcy5sZW5ndGggPCAxKSB7XG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRSlcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTClcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTClcblxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoSU5TVEFMTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShESVNBQkxFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHN0YXRlcykge1xuICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkRJU0FCTEU6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRU5BQkxFKVxuICAgICAgICAgIHJldHVybiBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLklOU1RBTEw6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLklOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuTUFOVUFMX0lOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLCBpZClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlKGlkOiBzdHJpbmcsIHN0YXRlOiBFeHRlbnNpb25TdGF0ZSkge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgbGV0IGRlbGV0ZWRcblxuICAgIHN3aXRjaCAoc3RhdGUpIHtcbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmRpc2FibGVkW2lkXVxuICAgICAgICBicmVha1xuXG4gICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmVuYWJsZWRbaWRdXG4gICAgICAgIGJyZWFrXG5cbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcblxuICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLm1hbnVhbEluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVsZXRlZFxuICB9XG5cbiAgcHJpdmF0ZSBhZGQoZXh0ZW5zaW9uOiBJRXh0ZW5zaW9uLCAuLi5zdGF0ZXM6IEV4dGVuc2lvblN0YXRlW10pIHtcbiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHN0YXRlcykge1xuICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkRJU0FCTEU6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTiwgZXh0ZW5zaW9uLmlkLCBleHRlbnNpb24pXG4gICAgICAgICAgdGhpcy5kaXNhYmxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgICBTaGFyZWRDb25maWcuYWRkVG9PYmplY3RMb2NhbERhdGEoRU5BQkxFRF9FWFRFTlNJT04sIGV4dGVuc2lvbi5pZCwgZXh0ZW5zaW9uKVxuICAgICAgICAgIHRoaXMuZW5hYmxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLklOU1RBTEw6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04sIGV4dGVuc2lvbi5pZCwgZXh0ZW5zaW9uKVxuICAgICAgICAgIHRoaXMuaW5zdGFsbGVkW2V4dGVuc2lvbi5pZF0gPSBleHRlbnNpb25cbiAgICAgICAgICBicmVha1xuXG4gICAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuTUFOVUFMX0lOU1RBTEw6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLCBleHRlbnNpb24uaWQsIGV4dGVuc2lvbilcbiAgICAgICAgICB0aGlzLmluc3RhbGxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBlbmFibGUoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgdGhpcy5yZW1vdmUoaWQsIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgdGhpcy5hZGQoZXh0ZW5zaW9uLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGlkLCBFVkVOVF9FWFRFTlNJT05fRU5BQkxFKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBkaXNhYmxlKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBleHRlbnNpb24gPSB0aGlzLmluc3RhbGxlZFtpZF1cbiAgICBpZiAoIWV4dGVuc2lvbikge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIHRoaXMucmVtb3ZlKGlkLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5hZGQoZXh0ZW5zaW9uLCBFeHRlbnNpb25TdGF0ZS5ESVNBQkxFKVxuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChpZCwgRVZFTlRfRVhURU5TSU9OX0RJU0FCTEUpXG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlzRW5hYmxlZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5lbmFibGVkW2lkXVxuICB9XG5cbiAgaXNEaXNhYmxlZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5kaXNhYmxlZFtpZF1cbiAgfVxuXG4gIGlzSW5zdGFsbGVkKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISF0aGlzLmluc3RhbGxlZFtpZF1cbiAgfVxuXG4gIGlzQnVpbHRpbihpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5pbnN0YWxsZWRbaWRdPy5idWlsdGluXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXh0ZW5zaW9uUG9vbFxuIl19