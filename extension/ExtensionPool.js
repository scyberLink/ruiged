"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExtensionState = void 0;
const SharedConfig_1 = __importDefault(require("../common/SharedConfig"));
const constants_1 = require("../common/constants");
const ExtensionLoader_1 = __importDefault(require("./ExtensionLoader"));
const builtinextensions_json_1 = __importDefault(require("../builtinextensions.json"));
const NullException_1 = __importDefault(require("../common/exceptions/NullException"));
var ExtensionState;
(function (ExtensionState) {
    ExtensionState["BUILTIN"] = "builtin";
    ExtensionState["ENABLE"] = "enable";
    ExtensionState["DISABLE"] = "disable";
    ExtensionState["INSTALL"] = "install";
    ExtensionState["MANUAL_INSTALL"] = "manualInstall";
})(ExtensionState = exports.ExtensionState || (exports.ExtensionState = {}));
class ExtensionPool {
    constructor(appContainer, load) {
        this.builtin = [];
        this.installed = {};
        this.enabled = {};
        this.disabled = {};
        this.manualInstalled = {};
        this.appContainer = appContainer;
        this.loader = new ExtensionLoader_1.default();
        this.init(load);
    }
    getEvent(id, eventType) {
        return new CustomEvent(eventType, {
            detail: { [constants_1.EXTENSION_EVENT_DATA]: id },
        });
    }
    dispatchEvent(id, eventType) {
        dispatchEvent(this.getEvent(id, eventType));
    }
    init(load) {
        return __awaiter(this, void 0, void 0, function* () {
            const installed = SharedConfig_1.default.getLocalData(constants_1.INSTALLED_EXTENSION);
            const enabled = SharedConfig_1.default.getLocalData(constants_1.ENABLED_EXTENSION);
            const disabled = SharedConfig_1.default.getLocalData(constants_1.DISABLED_EXTENSION);
            const manualInstalled = SharedConfig_1.default.getLocalData(constants_1.MANUAL_INSTALLED_EXTENSION);
            if (installed) {
                this.installed = installed;
            }
            if (enabled) {
                this.enabled = enabled;
            }
            if (disabled) {
                this.disabled = disabled;
            }
            if (manualInstalled) {
                this.manualInstalled = manualInstalled;
            }
            this.builtin = builtinextensions_json_1.default;
            if (!this.installed || Object.values(this.installed).length <= 0) {
                for (const id of this.builtin) {
                    this.install(id);
                }
            }
            this.loadExtension(load);
        });
    }
    loadExtension(load) {
        if (load && !this.appContainer) {
            throw new NullException_1.default('Cannot load extensions. App Container Object is null');
        }
        if (load) {
            for (const enabledExtension of Object.values(this.enabled)) {
                this.loader.load(enabledExtension, this.appContainer).then((_val) => {
                    console.log(_val);
                });
            }
        }
    }
    install(id) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.installed[id]) {
                return false;
            }
            this.remove(id);
            const extension = (yield this.loader.getExtension(id));
            extension.builtin = this.builtin.some((extensionId) => id == extensionId);
            if (extension) {
                return false;
            }
            this.add(extension, ExtensionState.INSTALL, ExtensionState.ENABLE);
            this.dispatchEvent(id, constants_1.EVENT_EXTENSION_INSTALL);
            return true;
        });
    }
    manualInstall(extension) {
        this.remove(extension.id);
        this.add(extension, ExtensionState.MANUAL_INSTALL, ExtensionState.INSTALL, ExtensionState.ENABLE);
        this.dispatchEvent(extension.id, constants_1.EVENT_EXTENSION_MANUAL_INSTALL);
        return true;
    }
    uninstall(id) {
        const removed = this.remove(id);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_UNINSTALL);
        return removed;
    }
    remove(id, ...states) {
        if (!states || states.length < 1) {
            this.delete(id, ExtensionState.DISABLE);
            this.delete(id, ExtensionState.ENABLE);
            this.delete(id, ExtensionState.INSTALL);
            this.delete(id, ExtensionState.MANUAL_INSTALL);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.INSTALLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.ENABLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.DISABLED_EXTENSION, id);
            SharedConfig_1.default.removeFromObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, id);
            return true;
        }
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    this.delete(id, ExtensionState.DISABLE);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.DISABLED_EXTENSION, id);
                    break;
                case ExtensionState.ENABLE:
                    this.delete(id, ExtensionState.ENABLE);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.ENABLED_EXTENSION, id);
                    break;
                case ExtensionState.INSTALL:
                    this.delete(id, ExtensionState.INSTALL);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.INSTALLED_EXTENSION, id);
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    this.delete(id, ExtensionState.MANUAL_INSTALL);
                    return SharedConfig_1.default.removeFromObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, id);
                    break;
            }
        }
    }
    delete(id, state) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        let deleted;
        switch (state) {
            case ExtensionState.DISABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.disabled[id];
                break;
            case ExtensionState.ENABLE:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.enabled[id];
                break;
            case ExtensionState.INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.installed[id];
                break;
            case ExtensionState.MANUAL_INSTALL:
                deleted = { deleted: this.disabled[id] }.deleted;
                delete this.manualInstalled[id];
                break;
        }
        return deleted;
    }
    add(extension, ...states) {
        for (const state of states) {
            switch (state) {
                case ExtensionState.DISABLE:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.DISABLED_EXTENSION, extension.id, extension);
                    this.disabled[extension.id] = extension;
                    break;
                case ExtensionState.ENABLE:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.ENABLED_EXTENSION, extension.id, extension);
                    this.enabled[extension.id] = extension;
                    break;
                case ExtensionState.INSTALL:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    break;
                case ExtensionState.MANUAL_INSTALL:
                    SharedConfig_1.default.addToObjectLocalData(constants_1.MANUAL_INSTALLED_EXTENSION, extension.id, extension);
                    this.installed[extension.id] = extension;
                    break;
            }
        }
    }
    enable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.DISABLE);
        this.add(extension, ExtensionState.ENABLE);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_ENABLE);
        return true;
    }
    disable(id) {
        const extension = this.installed[id];
        if (!extension) {
            return false;
        }
        this.remove(id, ExtensionState.ENABLE);
        this.add(extension, ExtensionState.DISABLE);
        this.dispatchEvent(id, constants_1.EVENT_EXTENSION_DISABLE);
        return true;
    }
    isEnabled(id) {
        return !!this.enabled[id];
    }
    isDisabled(id) {
        return !!this.disabled[id];
    }
    isInstalled(id) {
        return !!this.installed[id];
    }
    isBuiltin(id) {
        var _a;
        return !!((_a = this.installed[id]) === null || _a === void 0 ? void 0 : _a.builtin);
    }
}
exports.default = ExtensionPool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXh0ZW5zaW9uUG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHRlbnNpb24vRXh0ZW5zaW9uUG9vbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQSwwRUFBaUQ7QUFDakQsbURBVzRCO0FBRTVCLHdFQUErQztBQUMvQyx1RkFBeUQ7QUFFekQsdUZBQThEO0FBRzlELElBQVksY0FNWDtBQU5ELFdBQVksY0FBYztJQUN4QixxQ0FBbUIsQ0FBQTtJQUNuQixtQ0FBaUIsQ0FBQTtJQUNqQixxQ0FBbUIsQ0FBQTtJQUNuQixxQ0FBbUIsQ0FBQTtJQUNuQixrREFBZ0MsQ0FBQTtBQUNsQyxDQUFDLEVBTlcsY0FBYyxHQUFkLHNCQUFjLEtBQWQsc0JBQWMsUUFNekI7QUFVRCxNQUFNLGFBQWE7SUFVakIsWUFBWSxZQUE0QixFQUFFLElBQWM7UUFOaEQsWUFBTyxHQUFhLEVBQUUsQ0FBQTtRQUN0QixjQUFTLEdBQW1CLEVBQUUsQ0FBQTtRQUM5QixZQUFPLEdBQW1CLEVBQUUsQ0FBQTtRQUM1QixhQUFRLEdBQW1CLEVBQUUsQ0FBQTtRQUM3QixvQkFBZSxHQUFtQixFQUFFLENBQUE7UUFHMUMsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUE7UUFDaEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHlCQUFlLEVBQUUsQ0FBQTtRQUVuQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ2pCLENBQUM7SUFFRCxRQUFRLENBQUMsRUFBVSxFQUFFLFNBQWlCO1FBQ3BDLE9BQU8sSUFBSSxXQUFXLENBQTRCLFNBQVMsRUFBRTtZQUMzRCxNQUFNLEVBQUUsRUFBRSxDQUFDLGdDQUFvQixDQUFDLEVBQUUsRUFBRSxFQUFFO1NBQ3ZDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxhQUFhLENBQUMsRUFBVSxFQUFFLFNBQWlCO1FBQ3pDLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxD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bnQiOlsiaW1wb3J0IFNoYXJlZENvbmZpZyBmcm9tICcuLi9jb21tb24vU2hhcmVkQ29uZmlnJ1xuaW1wb3J0IHtcbiAgSU5TVEFMTEVEX0VYVEVOU0lPTixcbiAgRU5BQkxFRF9FWFRFTlNJT04sXG4gIERJU0FCTEVEX0VYVEVOU0lPTixcbiAgRVhURU5TSU9OX0VWRU5UX0RBVEEsXG4gIEVWRU5UX0VYVEVOU0lPTl9ESVNBQkxFLFxuICBFVkVOVF9FWFRFTlNJT05fRU5BQkxFLFxuICBFVkVOVF9FWFRFTlNJT05fSU5TVEFMTCxcbiAgRVZFTlRfRVhURU5TSU9OX01BTlVBTF9JTlNUQUxMLFxuICBFVkVOVF9FWFRFTlNJT05fVU5JTlNUQUxMLFxuICBNQU5VQUxfSU5TVEFMTEVEX0VYVEVOU0lPTixcbn0gZnJvbSAnLi4vY29tbW9uL2NvbnN0YW50cydcbmltcG9ydCBJQXBwQ29udGFpbmVyIGZyb20gJy4uL2xheWVycy92aWV3L2FwcGxpY2F0aW9uL2NvbXBvbmVudHMvYmFzZS9tb2RlbC9JQXBwQ29udGFpbmVyJ1xuaW1wb3J0IEV4dGVuc2lvbkxvYWRlciBmcm9tICcuL0V4dGVuc2lvbkxvYWRlcidcbmltcG9ydCBidWlsdGluRXh0ZW5zaW9ucyBmcm9tICcuLi9idWlsdGluZXh0ZW5zaW9ucy5qc29uJ1xuaW1wb3J0IElFeHRlbnNpb24gZnJvbSAnLi9JRXh0ZW5zaW9uJ1xuaW1wb3J0IE51bGxFeGNlcHRpb24gZnJvbSAnLi4vY29tbW9uL2V4Y2VwdGlvbnMvTnVsbEV4Y2VwdGlvbidcbmltcG9ydCBJQW55T2JqZWN0IGZyb20gJy4uL2NvbW1vbi9tb2RlbHMvSUFueU9iamVjdCdcblxuZXhwb3J0IGVudW0gRXh0ZW5zaW9uU3RhdGUge1xuICBCVUlMVElOID0gJ2J1aWx0aW4nLFxuICBFTkFCTEUgPSAnZW5hYmxlJyxcbiAgRElTQUJMRSA9ICdkaXNhYmxlJyxcbiAgSU5TVEFMTCA9ICdpbnN0YWxsJyxcbiAgTUFOVUFMX0lOU1RBTEwgPSAnbWFudWFsSW5zdGFsbCcsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRVhURU5TSU9OX0VWRU5UX0RBVEFfVFlQRSB7XG4gIFtFWFRFTlNJT05fRVZFTlRfREFUQV06IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVuc2lvblN0b3JlIHtcbiAgW2tleTogc3RyaW5nXTogSUV4dGVuc2lvblxufVxuXG5jbGFzcyBFeHRlbnNpb25Qb29sIHtcbiAgcHJpdmF0ZSBhcHBDb250YWluZXI/OiBJQXBwQ29udGFpbmVyXG4gIHByaXZhdGUgbG9hZGVyITogRXh0ZW5zaW9uTG9hZGVyXG5cbiAgcHJpdmF0ZSBidWlsdGluOiBzdHJpbmdbXSA9IFtdXG4gIHByaXZhdGUgaW5zdGFsbGVkOiBFeHRlbnNpb25TdG9yZSA9IHt9XG4gIHByaXZhdGUgZW5hYmxlZDogRXh0ZW5zaW9uU3RvcmUgPSB7fVxuICBwcml2YXRlIGRpc2FibGVkOiBFeHRlbnNpb25TdG9yZSA9IHt9XG4gIHByaXZhdGUgbWFudWFsSW5zdGFsbGVkOiBFeHRlbnNpb25TdG9yZSA9IHt9XG5cbiAgY29uc3RydWN0b3IoYXBwQ29udGFpbmVyPzogSUFwcENvbnRhaW5lciwgbG9hZD86IGJvb2xlYW4pIHtcbiAgICB0aGlzLmFwcENvbnRhaW5lciA9IGFwcENvbnRhaW5lclxuICAgIHRoaXMubG9hZGVyID0gbmV3IEV4dGVuc2lvbkxvYWRlcigpXG5cbiAgICB0aGlzLmluaXQobG9hZClcbiAgfVxuXG4gIGdldEV2ZW50KGlkOiBzdHJpbmcsIGV2ZW50VHlwZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBDdXN0b21FdmVudDxFWFRFTlNJT05fRVZFTlRfREFUQV9UWVBFPihldmVudFR5cGUsIHtcbiAgICAgIGRldGFpbDogeyBbRVhURU5TSU9OX0VWRU5UX0RBVEFdOiBpZCB9LFxuICAgIH0pXG4gIH1cblxuICBkaXNwYXRjaEV2ZW50KGlkOiBzdHJpbmcsIGV2ZW50VHlwZTogc3RyaW5nKSB7XG4gICAgZGlzcGF0Y2hFdmVudCh0aGlzLmdldEV2ZW50KGlkLCBldmVudFR5cGUpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0KGxvYWQ/OiBib29sZWFuKSB7XG4gICAgY29uc3QgaW5zdGFsbGVkOiBFeHRlbnNpb25TdG9yZSA9IFNoYXJlZENvbmZpZy5nZXRMb2NhbERhdGEoSU5TVEFMTEVEX0VYVEVOU0lPTikgYXMgSUFueU9iamVjdFxuICAgIGNvbnN0IGVuYWJsZWQ6IEV4dGVuc2lvblN0b3JlID0gU2hhcmVkQ29uZmlnLmdldExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTikgYXMgSUFueU9iamVjdFxuICAgIGNvbnN0IGRpc2FibGVkOiBFeHRlbnNpb25TdG9yZSA9IFNoYXJlZENvbmZpZy5nZXRMb2NhbERhdGEoRElTQUJMRURfRVhURU5TSU9OKSBhcyBJQW55T2JqZWN0XG4gICAgY29uc3QgbWFudWFsSW5zdGFsbGVkOiBFeHRlbnNpb25TdG9yZSA9IFNoYXJlZENvbmZpZy5nZXRMb2NhbERhdGEoTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04pIGFzIElBbnlPYmplY3RcblxuICAgIGlmIChpbnN0YWxsZWQpIHtcbiAgICAgIHRoaXMuaW5zdGFsbGVkID0gaW5zdGFsbGVkXG4gICAgfVxuXG4gICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgIHRoaXMuZW5hYmxlZCA9IGVuYWJsZWRcbiAgICB9XG5cbiAgICBpZiAoZGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuZGlzYWJsZWQgPSBkaXNhYmxlZFxuICAgIH1cblxuICAgIGlmIChtYW51YWxJbnN0YWxsZWQpIHtcbiAgICAgIHRoaXMubWFudWFsSW5zdGFsbGVkID0gbWFudWFsSW5zdGFsbGVkXG4gICAgfVxuXG4gICAgdGhpcy5idWlsdGluID0gYnVpbHRpbkV4dGVuc2lvbnNcblxuICAgIGlmICghdGhpcy5pbnN0YWxsZWQgfHwgT2JqZWN0LnZhbHVlcyh0aGlzLmluc3RhbGxlZCkubGVuZ3RoIDw9IDApIHtcbiAgICAgIGZvciAoY29uc3QgaWQgb2YgdGhpcy5idWlsdGluKSB7XG4gICAgICAgIHRoaXMuaW5zdGFsbChpZClcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmxvYWRFeHRlbnNpb24obG9hZClcbiAgfVxuXG4gIGxvYWRFeHRlbnNpb24obG9hZD86IGJvb2xlYW4pIHtcbiAgICBpZiAobG9hZCAmJiAhdGhpcy5hcHBDb250YWluZXIpIHtcbiAgICAgIHRocm93IG5ldyBOdWxsRXhjZXB0aW9uKCdDYW5ub3QgbG9hZCBleHRlbnNpb25zLiBBcHAgQ29udGFpbmVyIE9iamVjdCBpcyBudWxsJylcbiAgICB9XG4gICAgaWYgKGxvYWQpIHtcbiAgICAgIGZvciAoY29uc3QgZW5hYmxlZEV4dGVuc2lvbiBvZiBPYmplY3QudmFsdWVzKHRoaXMuZW5hYmxlZCkpIHtcbiAgICAgICAgdGhpcy5sb2FkZXIubG9hZChlbmFibGVkRXh0ZW5zaW9uLCB0aGlzLmFwcENvbnRhaW5lciBhcyBJQXBwQ29udGFpbmVyKS50aGVuKChfdmFsKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coX3ZhbClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5pbnN0YWxsZWRbaWRdKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZShpZClcblxuICAgIGNvbnN0IGV4dGVuc2lvbjogSUV4dGVuc2lvbiA9IChhd2FpdCB0aGlzLmxvYWRlci5nZXRFeHRlbnNpb24oaWQpKSBhcyBJRXh0ZW5zaW9uXG4gICAgZXh0ZW5zaW9uIS5idWlsdGluID0gdGhpcy5idWlsdGluLnNvbWUoKGV4dGVuc2lvbklkKSA9PiBpZCA9PSBleHRlbnNpb25JZClcbiAgICBpZiAoZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLklOU1RBTEwsIEV4dGVuc2lvblN0YXRlLkVOQUJMRSlcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBtYW51YWxJbnN0YWxsKGV4dGVuc2lvbjogSUV4dGVuc2lvbikge1xuICAgIHRoaXMucmVtb3ZlKGV4dGVuc2lvbi5pZClcbiAgICB0aGlzLmFkZChleHRlbnNpb24sIEV4dGVuc2lvblN0YXRlLk1BTlVBTF9JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5JTlNUQUxMLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV4dGVuc2lvbi5pZCwgRVZFTlRfRVhURU5TSU9OX01BTlVBTF9JTlNUQUxMKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICB1bmluc3RhbGwoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJlbW92ZWQgPSB0aGlzLnJlbW92ZShpZClcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoaWQsIEVWRU5UX0VYVEVOU0lPTl9VTklOU1RBTEwpXG4gICAgcmV0dXJuIHJlbW92ZWRcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlKGlkOiBzdHJpbmcsIC4uLnN0YXRlczogRXh0ZW5zaW9uU3RhdGVbXSkge1xuICAgIGlmICghc3RhdGVzIHx8IHN0YXRlcy5sZW5ndGggPCAxKSB7XG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRSlcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTClcbiAgICAgIHRoaXMuZGVsZXRlKGlkLCBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTClcblxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoSU5TVEFMTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShESVNBQkxFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgU2hhcmVkQ29uZmlnLnJlbW92ZUZyb21PYmplY3RMb2NhbERhdGEoTUFOVUFMX0lOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHN0YXRlcykge1xuICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkRJU0FCTEU6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuRU5BQkxFKVxuICAgICAgICAgIHJldHVybiBTaGFyZWRDb25maWcucmVtb3ZlRnJvbU9iamVjdExvY2FsRGF0YShFTkFCTEVEX0VYVEVOU0lPTiwgaWQpXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLklOU1RBTEw6XG4gICAgICAgICAgdGhpcy5kZWxldGUoaWQsIEV4dGVuc2lvblN0YXRlLklOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04sIGlkKVxuICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgICB0aGlzLmRlbGV0ZShpZCwgRXh0ZW5zaW9uU3RhdGUuTUFOVUFMX0lOU1RBTEwpXG4gICAgICAgICAgcmV0dXJuIFNoYXJlZENvbmZpZy5yZW1vdmVGcm9tT2JqZWN0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLCBpZClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlKGlkOiBzdHJpbmcsIHN0YXRlOiBFeHRlbnNpb25TdGF0ZSkge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgbGV0IGRlbGV0ZWRcblxuICAgIHN3aXRjaCAoc3RhdGUpIHtcbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuRElTQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmRpc2FibGVkW2lkXVxuICAgICAgICBicmVha1xuXG4gICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmVuYWJsZWRbaWRdXG4gICAgICAgIGJyZWFrXG5cbiAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLmluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcblxuICAgICAgY2FzZSBFeHRlbnNpb25TdGF0ZS5NQU5VQUxfSU5TVEFMTDpcbiAgICAgICAgZGVsZXRlZCA9IHsgZGVsZXRlZDogdGhpcy5kaXNhYmxlZFtpZF0gfS5kZWxldGVkXG4gICAgICAgIGRlbGV0ZSB0aGlzLm1hbnVhbEluc3RhbGxlZFtpZF1cbiAgICAgICAgYnJlYWtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVsZXRlZFxuICB9XG5cbiAgcHJpdmF0ZSBhZGQoZXh0ZW5zaW9uOiBJRXh0ZW5zaW9uLCAuLi5zdGF0ZXM6IEV4dGVuc2lvblN0YXRlW10pIHtcbiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHN0YXRlcykge1xuICAgICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkRJU0FCTEU6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKERJU0FCTEVEX0VYVEVOU0lPTiwgZXh0ZW5zaW9uLmlkLCBleHRlbnNpb24pXG4gICAgICAgICAgdGhpcy5kaXNhYmxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLkVOQUJMRTpcbiAgICAgICAgICBTaGFyZWRDb25maWcuYWRkVG9PYmplY3RMb2NhbERhdGEoRU5BQkxFRF9FWFRFTlNJT04sIGV4dGVuc2lvbi5pZCwgZXh0ZW5zaW9uKVxuICAgICAgICAgIHRoaXMuZW5hYmxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcblxuICAgICAgICBjYXNlIEV4dGVuc2lvblN0YXRlLklOU1RBTEw6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKElOU1RBTExFRF9FWFRFTlNJT04sIGV4dGVuc2lvbi5pZCwgZXh0ZW5zaW9uKVxuICAgICAgICAgIHRoaXMuaW5zdGFsbGVkW2V4dGVuc2lvbi5pZF0gPSBleHRlbnNpb25cbiAgICAgICAgICBicmVha1xuXG4gICAgICAgIGNhc2UgRXh0ZW5zaW9uU3RhdGUuTUFOVUFMX0lOU1RBTEw6XG4gICAgICAgICAgU2hhcmVkQ29uZmlnLmFkZFRvT2JqZWN0TG9jYWxEYXRhKE1BTlVBTF9JTlNUQUxMRURfRVhURU5TSU9OLCBleHRlbnNpb24uaWQsIGV4dGVuc2lvbilcbiAgICAgICAgICB0aGlzLmluc3RhbGxlZFtleHRlbnNpb24uaWRdID0gZXh0ZW5zaW9uXG4gICAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBlbmFibGUoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHRoaXMuaW5zdGFsbGVkW2lkXVxuICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgdGhpcy5yZW1vdmUoaWQsIEV4dGVuc2lvblN0YXRlLkRJU0FCTEUpXG4gICAgdGhpcy5hZGQoZXh0ZW5zaW9uLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KGlkLCBFVkVOVF9FWFRFTlNJT05fRU5BQkxFKVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBkaXNhYmxlKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBleHRlbnNpb24gPSB0aGlzLmluc3RhbGxlZFtpZF1cbiAgICBpZiAoIWV4dGVuc2lvbikge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIHRoaXMucmVtb3ZlKGlkLCBFeHRlbnNpb25TdGF0ZS5FTkFCTEUpXG4gICAgdGhpcy5hZGQoZXh0ZW5zaW9uLCBFeHRlbnNpb25TdGF0ZS5ESVNBQkxFKVxuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChpZCwgRVZFTlRfRVhURU5TSU9OX0RJU0FCTEUpXG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlzRW5hYmxlZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5lbmFibGVkW2lkXVxuICB9XG5cbiAgaXNEaXNhYmxlZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5kaXNhYmxlZFtpZF1cbiAgfVxuXG4gIGlzSW5zdGFsbGVkKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISF0aGlzLmluc3RhbGxlZFtpZF1cbiAgfVxuXG4gIGlzQnVpbHRpbihpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICEhdGhpcy5pbnN0YWxsZWRbaWRdPy5idWlsdGluXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXh0ZW5zaW9uUG9vbFxuIl19